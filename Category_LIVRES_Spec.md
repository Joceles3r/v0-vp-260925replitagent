# Category_LIVRES_Spec.md

## ðŸ“š CatÃ©gorie Â« LIVRES Â» â€” SpÃ©cification complÃ¨te (v.24/09/2025)

### Objectif
Lancer une catÃ©gorie **LIVRES** cohÃ©rente avec VISUAL : 100 auteurs en compÃ©tition, **cycle mensuel calendaire**, rÃ¨gles de votes et de redistribution intÃ©grÃ©es aux agents **VisualAI** (maÃ®tre) et **VisualFinanceAI** (exÃ©cuteur).

---

## 1) ParamÃ¨tres & cycle de vie

- **CapacitÃ© par catÃ©gorie** : 100 auteurs (extensible Ã  200 â†’ TOP 20, voir Â§12).
- **Calendrier mensuel** :
  - **Ouverture** : le **1er** Ã  **00:00:00** (Europe/Paris)
  - **ClÃ´ture** : le **dernier jour du mois** Ã  **23:59:59** (Europe/Paris)
  - FÃ©vrier : **28** ou **29** jours selon l'annÃ©e bissextile
- **DÃ©clenchement** : ouverture immÃ©diate Ã  Nâ‰¤100 auteurs.
- **ClÃ´ture** : Ã  la fin du mois, calcul TOP 10, pot mensuel, paiements.
- **Auto-report** : tout **auteur classÃ© TOP 10** est **automatiquement inscrit** au mois suivant.
- **Prolongation/repÃªchage** : un **auteur classÃ© 11â€“100** peut intÃ©grer le **mois suivant** en rÃ©glant **25 â‚¬** (`extension_price_eur`, paramÃ©trable). Il dispose de **24 h** aprÃ¨s la clÃ´ture ; sinon la place revient au premier en file d'attente.
- **File d'attente** : visible jusqu'Ã  **300** auteurs (au-delÃ  **ADMIN** uniquement).

### Configuration planifiÃ©e (CRON/RRULE)
- **Ouverture** : `RRULE:FREQ=MONTHLY;BYMONTHDAY=1;BYHOUR=0;BYMINUTE=0;BYSECOND=0`
- **ClÃ´ture** : `RRULE:FREQ=MONTHLY;BYMONTHDAY=-1;BYHOUR=23;BYMINUTE=59;BYSECOND=59`  
  *(BYMONTHDAY=-1 = dernier jour du mois ; appliquer TZ Europe/Paris)*

---

## 2) Prix auteurs & tranches investi-lecteurs

### Prix imposÃ©s (auteurs)
- Prix de vente **unitaire** du livre numÃ©rique : **{2, 3, 4, 5, 8 â‚¬}** (max **8 â‚¬**).

### Tranches d'engagement (investi-lecteurs)
- **{2, 3, 4, 5, 6, 8, 10, 12, 15, 20 â‚¬}**, avec possibilitÃ© de payer un **multiple** du prix unitaire (sans dÃ©passer 20 â‚¬).
- Le paiement **achÃ¨te** le livre (accÃ¨s par **token**) ; tout montant au-dessus du prix unitaire est traitÃ© comme **soutien** (tip) et **donne des votes** supplÃ©mentaires.

> Remarque : paiements en **euros** (Stripe). Optionnellement, permettre le paiement via **VISUpoints** (conversion interne 100 pts = 1 â‚¬) si l'utilisateur a un solde suffisant.

---

## 3) Votes (barÃ¨me standard VISUAL)
| Montant (â‚¬) | 2 | 3 | 4 | 5 | 6 | 8 | 10 | 12 | 15 | 20 |
|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| **Votes** | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |

- **SÃ©lection** : les **10 livres** ayant **le plus de votes** sur la fenÃªtre du **mois** forment le **TOP 10**.
- **Ordre final (tie-break & robustesse)** : VisualAI applique la mÃ©thode VISUAL :
  1) **Coefficient d'engagement** `Coeff = montantTotal / max(1, nbInvestisseurs)` (tri dÃ©croissant),
  2) Si Ã©galitÃ© : **+ d'investisseurs uniques**,
  3) Puis **montantTotal** le plus Ã©levÃ©,
  4) Puis **anciennetÃ©** (plus ancien gagne),
  5) Sinon **tirage pseudo-alÃ©atoire** auditÃ© (seed = idCatÃ©gorie+horodatage).

---

## 4) TÃ©lÃ©chargement & token sÃ©curisÃ©

- AprÃ¨s paiement, l'investi-lecteur reÃ§oit un **token de tÃ©lÃ©chargement** (lien expirable) vers le **stockage auteur**.
- **Filigrane/empreinte** : fichier marquÃ© (watermark) avec **ID acheteur** + **horodatage** (dissuasion anti-piratage).
- **ReÃ§u** : justificatif numÃ©rique (id, prix, TVA, moyen de paiement).

---

## 5) Payout des ventes (instantanÃ©)

- **VISUAL** prÃ©lÃ¨ve **30 %**, **Auteur** reÃ§oit **70 %** de chaque vente (`infoarticle_platform_fee_pct=0.30`).
- ComptabilitÃ© au **centime** ; transferts via **Stripe Connect** ; journalisation **Ledger** + **Audit**.

---

## 6) Pot mensuel (redistribution en fin de mois)

**DÃ©finition du pot** : sur la **fenÃªtre du mois**, on agrÃ¨ge les **sommes versÃ©es par les investiâ€‘lecteurs classÃ©s 11â€“100** (rangs calculÃ©s sur l'ensemble du mois).

### Groupes bÃ©nÃ©ficiaires
- **Auteurs gagnants** : les **TOP 10 auteurs** du mois (ou **TOP 20** si l'Ã©dition est Ã©tendue).
- **Investiâ€‘lecteurs gagnants** : **tous** les lecteurs ayant **achetÃ© â‰¥ 1 livre** d'un **auteur TOP 10** durant le mois (uniques).

### ParamÃ¨tres (par dÃ©faut)
- Part **auteurs** : **Î± = 60 %** du pot mensuel  
- Part **lecteurs** : **Î² = 40 %** du pot mensuel  
- Mode : **Ã©quipartition** par dÃ©faut dans chaque groupe (paramÃ©trable : `weighted`, `group_ratio`).

### Formules (avec arrondis VISUAL)
Travailler en **centimes** puis appliquer l'**arrondi Ã  l'euro infÃ©rieur** pour les utilisateurs ; les **restes** (centimes & Ã©carts) vont Ã  **VISUAL**.

- Conversion : `S_c = round(S_pot Ã— 100)` (centimes)  
- Total auteurs (centimes) : `A_c = floor(Î± Ã— S_c)`  
- Total lecteurs (centimes) : `R_c = floor(Î² Ã— S_c)`

Si **N** = nombre d'auteurs gagnants (10 par dÃ©faut) et **M** = nombre d'investiâ€‘lecteurs gagnants (uniques) :

- **Part auteur unitaire (centimes)** :  
  `a_each_c = floor( A_c / N )` â†’ **versement utilisateur** `a_each_euro = floor(a_each_c / 100) Ã— 100`  
- **Part lecteur unitaire (centimes)** :  
  `r_each_c = floor( R_c / M )` â†’ **versement utilisateur** `r_each_euro = floor(r_each_c / 100) Ã— 100`

- **RÃ©sidu** (centimes) pour VISUAL :  
  `residual_c = S_c âˆ’ ( N Ã— a_each_euro + M Ã— r_each_euro )`  
  **VISUAL reÃ§oit** `residual_c` en plus de ses autres revenus (frais infra, etc.).

> Remarque : si `M = 0` (aucun lecteur gagnant), **R_c** est intÃ©gralement versÃ© aux **auteurs gagnants** (*fallback*) **ou** reportÃ© en **residu VISUAL** selon le paramÃ¨tre `pot_empty_readers_policy`.

---

## 7) VISUpoints (option d'incitation)

- Achat d'un livre â†’ attribution facultative de **VISUpoints** (ex. 1 â‚¬ = 5 pts ; **configurable**).
- Conversion globale VISUAL : **100 pts = 1 â‚¬**, **seuil 2 500 pts**, **KYC + Stripe** requis, **floor** Ã  l'euro.
- Compatible avec **Visiteur du Mois** (2 500 pts) et **streaks**.

---

## 8) Anti-plagiat & conformitÃ©

- **Acte de propriÃ©tÃ©** signÃ© Ã©lectroniquement ; stockage du document par l'auteur.
- **Scan de similaritÃ©** (anti-plagiat) lors de l'upload (hash + heuristiques + sampling).
- **DMCA-like** : procÃ©dure de retrait, contre-notification, arbitrage ADMIN.
- **KYC** auteurs/lecteurs pour retraits ; **2FA** requis pour auteurs (paiements) et investis-lecteurs (montants > seuil).

---

## 9) UI/UX & SEO

- **Mur TOP** : affichage **TOP 20** en temps rÃ©el (Ã  minima TOP 10), liste des 80 suivants accessible.
- **Compte Ã  rebours** : affiche **"ClÃ´ture : dernier jour du mois Ã  23:59:59 (Europe/Paris)"**.
- **Fiche auteur** : pseudo, rÃ©sumÃ©, prix, lien/token, notes (â˜… jusqu'Ã  5), rÃ©seaux sociaux (â‰¤5), stockage **10 livres** (extensible).
- **Langues** : traduction de chaque page (barre de langue) + **sous-titres** pour extraits audio/lecture (si fournis).
- **SEO** : sitemaps, Schema.org `Book`, OpenGraph, hreflang, canonical.

---

## 10) SÃ©curitÃ© & signalements

- **ModÃ©ration prÃ©ventive** : VisualAI peut **suspendre** un livre en attente de revue (contenu sensible).
- **Signalements** utilisateurs â†’ file de traitement ; blocage si rÃ©cidive/violation.
- **Anti-fraude** : dÃ©tection comptes liÃ©s, burst achats anormaux, remboursements en sÃ©rie â†’ **freeze** + alerte ADMIN.

---

## 11) IntÃ©gration agents IA

### VisualAI (maÃ®tre)
- Orchestration du **classement mensuel**, modÃ©ration, SEO/i18n, notifications, wallboards, tie-breakers.
- Ã‰met les ordres de paiements/redistributions (**pot mensuel** calendaire) Ã  **VisualFinanceAI**.

### VisualFinanceAI (exÃ©cuteur)
- Applique **70/30** par vente (centime), **pot 60/40**, **arrondis floor** pour utilisateurs, **restes â†’ VISUAL**.
- GÃ¨re les **payouts Stripe**, les **journaux Ledger/Audit**, la **conversion VISUpoints**.
- **Cadence mensuelle** : rapports et redistributions adaptÃ©s au calendrier mensuel.

---

## 12) Extension Ã  200 auteurs (TOP 20)

- CapacitÃ© : **200** auteurs, **TOP 20** gagnants.
- **Pot** : mÃªmes rÃ¨gles, rÃ©parti **60 %** (TOP 20 auteurs) / **40 %** (investi-lecteurs gagnants).
- **Affichage** : mur TOP 20 + pagination. Performance : caches/streaming adaptÃ©s.
- **Back-office** : paramÃ¨tres `max_authors=200`, `top_n=20`.

---

## 13) Pseudocode â€” Ã©vÃ©nements clÃ©s

### a) Vente d'un livre (70/30 + token)
\`\`\`ts
function onBookSold(orderId: string, bookId: string, authorId: string, grossEUR: number, buyerId: string){
  const gross_c = Math.round(grossEUR*100);
  const fee_c   = Math.round(gross_c * 0.30); // VISUAL
  const net_c   = gross_c - fee_c;            // auteur
  stripe.transfer("VISUAL", fee_c, {key:`fee:${orderId}`});
  stripe.transfer(authorId,  net_c, {key:`net:${orderId}`});
  ledger.record({orderId, bookId, authorId, buyerId, type:"book_sale", gross_c, fee_c, net_c});
  tokenService.issueDownloadToken(buyerId, bookId, {ttl: "72h", watermark:true});
}
\`\`\`

### b) Calcul TOP 10 (sÃ©lection votes â†’ ordre par Coeff + tie-breakers)
\`\`\`ts
function computeTop10(categoryId: string){
  const candidates = repo.fetchAuthors(categoryId);
  const byVotesDesc = candidates.sort((a,b)=> b.votes - a.votes).slice(0,10);
  const withCoeff = byVotesDesc.map(a=> ({...a, coeff: +(a.grossEUR / Math.max(1,a.uniqueBuyers)).toFixed(2)}));
  return withCoeff.sort((a,b)=> b.coeff - a.coeff || b.uniqueBuyers - a.uniqueBuyers || b.grossEUR - a.grossEUR || a.createdAt - b.createdAt || tieBreak(a.id,b.id));
}
\`\`\`

### c) Pot mensuel (60/40 ; Ã©quipartition par dÃ©faut)
\`\`\`ts
function closeMonth_Livres(s_pot_eur: number, authorsTopN: string[], readerWinners: string[]) {
  const ALPHA = 0.60; // auteurs
  const BETA  = 0.40; // lecteurs
  
  const S_c = Math.round(s_pot_eur * 100);
  const A_c = Math.floor(ALPHA * S_c);
  const R_c = Math.floor(BETA  * S_c);

  const N = authorsTopN.length; // 10 (ou 20)
  const M = readerWinners.length;

  const payouts: any[] = [];
  let paid_c = 0;

  if (N > 0) {
    const a_each_c = Math.floor(A_c / N);
    const a_each_e = Math.floor(a_each_c / 100) * 100; // euro floor
    for (const a of authorsTopN) { payouts.push({ type:"author_pot", user:a, cents:a_each_e }); paid_c += a_each_e; }
  }

  if (M > 0) {
    const r_each_c = Math.floor(R_c / M);
    const r_each_e = Math.floor(r_each_c / 100) * 100; // euro floor
    for (const r of readerWinners) { payouts.push({ type:"reader_pot", user:r, cents:r_each_e }); paid_c += r_each_e; }
  } else {
    // fallback paramÃ©trable : soit tout â†’ auteurs, soit tout â†’ VISUAL
    payouts.push({ type:"visual_residual_pot_readers_empty", cents: R_c });
    paid_c += 0;
  }

  const residual_c = Math.max(0, S_c - paid_c);
  payouts.push({ type:"visual_residuals", cents: residual_c });

  return payouts;
}
\`\`\`

---

## 14) Ajustements d'interface & d'admin

- Le **compte Ã  rebours** affiche **"ClÃ´ture : dernier jour du mois Ã  23:59:59 (Europe/Paris)"**.
- L'**Admin** visualise la **fenÃªtre mensuelle** et les **rangs 1â€“100** spÃ©cifiques au mois.
- Les **exports** (CSV/ledger) utilisent la **pÃ©riode mensuelle** comme partition temporelle.
- Les **rapports** de VisualAI & VisualFinanceAI pour **Livres** passent en **cadence mensuelle**.

---

## 15) Checklist conformitÃ© & admin

- **KYC obligatoire** pour retraits ; **2FA** pour auteurs/lecteurs (paiements).
- **CGU/Charte** : anti-plagiat, respect droits d'auteur, rÃ¨gles de remboursement.
- **Logs & audit** : dÃ©cisions IA, ventes, redistributions, litiges.
- **SEO/i18n** : hreflang, sitemaps, traductions Ã  jour.
- **ParamÃ¨tres runtime** : `extension_price_eur=25` (modifiable), `pot_split_authors=0.60`, `pot_split_readers=0.40`, `pot_mode="equipartition"`.

---

## 16) CompatibilitÃ© & invariants

- **70/30** sur chaque vente unitaire **inchangÃ©**.
- **VISUpoints** : 100 pts = 1 â‚¬, seuil 2 500 pts, conversion floor, KYC/Stripe requis **inchangÃ©s**.
- **SÃ©curitÃ©/antifraude/modÃ©ration/SEO** : inchangÃ©s.
- **TOP N extensible** : passage Ã  **TOP 20** (si 200 auteurs) â†’ les formules restent valables en remplaÃ§ant **N**.

---

## 17) Tests Ã  dÃ©rouler

- Mois de **28/29/30/31** jours : ouverture/clÃ´ture aux bons instants (TZ Europe/Paris, DST ok).
- Cas **M=0** lecteurs gagnants : appliquer la politique `pot_empty_readers_policy`.
- Arrondis : vÃ©rifier **euro floor** et **rÃ©sidus â†’ VISUAL**.
- Auto-report TOP 10 â†’ mois suivant, repÃªchage rang 11â€“100 (25 â‚¬) sous 24 h.

---

## 18) RÃ©sumÃ© exÃ©cutable

- **Cycle mensuel calendaire** (1er â†’ dernier jour du mois), 100 auteurs (ext. 200).
- **Prix auteurs** : 2/3/4/5/8 â‚¬ ; **Tranches** lecteurs 2â†’20 â‚¬ ; votes mappÃ©s.
- **Ventes** : **70/30** (auteur/VISUAL), token + watermark, reÃ§u.
- **TOP 10** : votes â†’ **Coeff** â†’ tie-breakers.
- **Pot mensuel** : **60/40** (auteurs/lecteurs gagnants), **floor Ã  l'euro**, restes â†’ VISUAL.
- **RepÃªchage** : 25 â‚¬ pour intÃ©grer le mois suivant (24 h aprÃ¨s clÃ´ture).
- **CRON/RRULE** : ouverture/clÃ´ture automatisÃ©es avec fuseau Europe/Paris.

---
