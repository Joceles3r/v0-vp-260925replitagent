# VISUAL - Formules Math√©matiques et R√©partitions Compl√®tes
**Version finale : 2025-10-24**

---

## üìã PR√âAMBULE

**Plateforme** : VISUAL  
**Slogan officiel** : *"Regarde-Investis-Gagne"*  
**R√©f√©rence interne** : **100 VISUpoints = 1 ‚Ç¨**

### Bar√®me Commun Investisseurs (euros ‚Üí votes)

| Montant (‚Ç¨) | 2 | 3 | 4 | 5 | 6 | 8 | 10 | 12 | 15 | 20 |
|-------------|---|---|---|---|---|---|----|----|----|----| 
| **Votes** | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |

**Application** : Toutes cat√©gories (Films, Vid√©os, Documentaires, Voix de l'Info, Livres, Podcasts, VSLS).

---

## üìë SOMMAIRE

1. [Films / Vid√©os / Documentaires](#1-films--vid√©os--documentaires----cl√¥ture-40302377)
2. [Voix de l'Info](#2-voix-de-linfo----vente-7030--pot-quotidien-6040)
3. [Livres](#3-livres----vente-7030--pot-mensuel-6040)
4. [Podcasts](#4-podcasts----vente-7030--pot-mensuel-40302010)
5. [VSLS (Visual Studio Live Show)](#5-vsls-visual-studio-live-show----40104010)
6. [Petites Annonces](#6-rubrique-petites-annonces----mod√®le-√©conomique-pro)
7. [R√®gles Transverses](#7-r√®gles-transverses)
8. [API & Settlement](#8-api--settlement-r√©f√©rence-technique)
9. [Check-list D√©ploiement](#9-check-list-d√©ploiement)

---

## 1) Films / Vid√©os / Documentaires ‚Äî Cl√¥ture **40/30/23/7 %**

### Formule de R√©partition

Soit **P** le **pot net** (apr√®s frais Stripe) √† la cl√¥ture de la cat√©gorie.

#### Distribution d√©taill√©e :

**A) 40 % ‚Üí Investisseurs TOP 10**

```
P_{I,Top10} = 0,40 √ó P

part_i = P_{I,Top10} √ó (V_i / Œ£_{j‚ààTop10} V_j)
```

O√π :
- `V_i` = votes de l'investisseur `i` sur les projets TOP 10
- R√©partition **pond√©r√©e** par le montant investi

---

**B) 30 % ‚Üí Porteurs de Projets TOP 10**

```
P_{C,Top10} = 0,30 √ó P

part_c = P_{C,Top10} √ó (score_c / Œ£ score_{Top10})
```

O√π :
- `score_c` = score final du projet `c` (votes √ó engagement √ó qualit√©)
- R√©partition **pond√©r√©e** par le score de classement

---

**C) 7 % ‚Üí Investisseurs rangs 11-100**

```
P_{I,11-100} = 0,07 √ó P
```

Distribution :
- **√âquiparti** (parts √©gales) **OU**
- **Pro-rata votes** (selon param√©trage admin)

---

**D) 23 % ‚Üí VISUAL (Plateforme)**

```
P_{VISUAL} = 0,23 √ó P
```

Inclut :
- Frais op√©rationnels
- Arrondis de calcul (bouclage au centime)
- R√©serve technique

---

### Quotas Cr√©ateurs (Rappel)

| Type de contenu | Dur√©e | Quota | Prix fixe |
|----------------|-------|-------|-----------|
| **Clips** | ‚â§ 5 min | 2/mois | 2 ‚Ç¨ |
| **Documentaires** | 5-30 min | 1/mois | 5 ‚Ç¨ ou 10 ‚Ç¨ |
| **Films** | > 30 min | 1/trimestre | 15 ‚Ç¨ |

---

## 2) Voix de l'Info ‚Äî **Vente 70/30** + **Pot quotidien 60/40**

### Flux A ‚Äî Vente Unitaire d'Article

```
Net_vente = Prix_pay√© - Frais_paiement

Auteur = 0,70 √ó Net_vente
VISUAL = 0,30 √ó Net_vente
```

**Arrondi** : Au centime pr√®s (0,01 ‚Ç¨)

---

### Flux B ‚Äî Pot du Jour (Distribution J ‚Üí J+1 √† 00:15)

Soit **P_day** le **pot net quotidien** cumul√©.

#### A) 60 % ‚Üí Auteurs TOP 10

```
P_{Auteurs} = 0,60 √ó P_day

part_a = P_{Auteurs} √ó (score_a / Œ£ score_{Top10})
```

**M√©thodes de pond√©ration** (configurable) :
- **Pro-rata score** (votes √ó engagement)
- **Poids par rang** : rang 1 = 10 points, rang 2 = 9 points, ..., rang 10 = 1 point

---

#### B) 40 % ‚Üí Lecteurs Gagnants

**Crit√®re d'√©ligibilit√©** : Avoir achet√© **‚â• 1 article** d'un auteur du TOP 10.

```
W_i = Œ£ (votes_i √ó poids_c)

part_i = 0,40 √ó P_day √ó (W_i / Œ£ W)
```

O√π :
- `votes_i` = nombre de votes du lecteur `i` sur articles TOP 10
- `poids_c` = coefficient de pond√©ration de l'auteur `c` (selon rang)

---

### R√®gles Sp√©cifiques

- **Fr√©quence** : Cl√¥ture quotidienne automatique (CRON √† 00:15 UTC+1)
- **Archivage** : Classements quotidiens conserv√©s 90 jours
- **D√©lai paiement** : T+2 jours ouvr√©s

---

## 3) Livres ‚Äî **Vente 70/30** + **Pot mensuel 60/40**

### Flux A ‚Äî Vente Unitaire de Livre

```
Net_vente = Prix_pay√© - Frais_paiement

Auteur = 0,70 √ó Net_vente
VISUAL = 0,30 √ó Net_vente
```

---

### Flux B ‚Äî Pot Mensuel (Mois Calendaire)

Soit **P_mois** le **pot net mensuel**.

#### A) 60 % ‚Üí Auteurs TOP 10

```
P_{Auteurs} = 0,60 √ó P_mois

part_a = P_{Auteurs} √ó (score_a / Œ£ score_{Top10})
```

**M√©thodes de pond√©ration** :
- **Pro-rata score** (votes √ó ventes √ó engagement)
- **Poids d√©gressif** : rang 1 = 10, rang 2 = 9, ..., rang 10 = 1

---

#### B) 40 % ‚Üí Lecteurs-Investisseurs Gagnants

**Crit√®re** : Avoir investi sur **‚â• 1 auteur du TOP 10**.

```
W_i = Œ£ (votes_i √ó poids_c)

part_i = 0,40 √ó P_mois √ó (W_i / Œ£ W)
```

---

### Syst√®me de Rep√™chage (Optionnel)

**Cible** : Auteurs class√©s **rangs 11-100**

- **Co√ªt** : 25 ‚Ç¨ (ticket de rep√™chage)
- **Fen√™tre** : 24 heures apr√®s cl√¥ture mensuelle
- **Effet** : Inscription automatique au cycle suivant (file d'attente prioritaire)

---

### Auto-Report TOP 10

**Param√©trable** par l'admin :
- **Activ√©** : TOP 10 reconduits automatiquement le mois suivant
- **D√©sactiv√©** : Retour en file d'attente g√©n√©rale

---

### Capacit√© Mensuelle

- **Target** : 100 auteurs/mois (param√®tre `TARGET_AUTHORS`)
- **Extensible** : Jusqu'√† 200 auteurs/mois selon charge serveur
- **File d'attente** : Visible jusqu'√† 10 000 auteurs dans admin

---

## 4) Podcasts ‚Äî **Vente 70/30** + **Pot mensuel 40/30/20/10**

### Flux A ‚Äî Vente √âpisode

```
Net_vente = Prix_pay√© - Frais_paiement

Porteur = 0,70 √ó Net_vente
VISUAL = 0,30 √ó Net_vente
```

---

### Flux B ‚Äî Pot Mensuel

Soit **P** le **pot net mensuel**.

#### A) 40 % ‚Üí Porteurs de Podcasts

```
P_{Porteurs} = 0,40 √ó P

part_p = P_{Porteurs} √ó (score_audio_p / Œ£ score_audio)
```

**Calcul score_audio** :
```
score_audio = impressions √ó compl√©tion
```

O√π :
- `impressions` = nombre total d'√©coutes
- `compl√©tion` = % moyen d'√©coute (0 √† 1)

---

#### B) 30 % ‚Üí Investisseurs

```
P_{Investisseurs} = 0,30 √ó P

part_i = P_{Investisseurs} √ó (weight_i / Œ£ weights)

weight_i = votes_i √ó listen_score_i
```

**Formule listen_score** :
```
listen_score = 0,7 √ó compl√©tion + 0,3 √ó auditeurs_uniques_norm
```

O√π :
- `compl√©tion` = % moyen d'√©coute compl√®te (0 √† 1)
- `auditeurs_uniques_norm` = ratio auditeurs uniques / total √©coutes (normalis√© 0-1)

---

**‚ö†Ô∏è CAP ANTI-CAPTURE** (Recommand√©) :

**Limite par investisseur** : ‚â§ **20 %** des votes globaux mensuels

```
IF votes_i / Œ£ votes_total > 0,20 THEN
  weight_i_capped = 0,20 √ó Œ£ votes_total √ó listen_score_i
```

**Objectif** : Pr√©venir la monopolisation par gros investisseurs.

---

#### C) 20 % ‚Üí VISUAL

```
P_{VISUAL} = 0,20 √ó P
```

---

#### D) 10 % ‚Üí Bonus Pool

```
P_{Bonus} = 0,10 √ó P
```

**Affectation** :
- **TOP 10 podcasts** : Primes de performance
- **Challenges sp√©ciaux** : √âv√©nements promotionnels
- **R√©serve technique** : Ajustements et arrondis

---

### Classement & Archivage

**Formule de classement** :
```
score_final = votes √ó listen_score
```

**Ordre** : D√©croissant (1 ‚Üí N)

**Archives** : Classements mensuels conserv√©s ind√©finiment (CSV + DB).

---

## 5) VSLS (Visual Studio Live Show) ‚Äî **40/10/40/10 %**

### Contexte

**VSLS** = Battles artistiques en **temps r√©el** avec votes **live** (WebSocket).

Soit **P_live** le **pot net** du show.

---

### R√©partition

#### A) 40 % ‚Üí Artiste Gagnant

```
P_{Gagnant} = 0,40 √ó P_live
```

---

#### B) 10 % ‚Üí Artiste Perdant

```
P_{Perdant} = 0,10 √ó P_live
```

**Objectif** : R√©compenser la participation (pas de sortie √† z√©ro).

---

#### C) 40 % ‚Üí Investisseurs Gagnants

**Crit√®re** : Avoir soutenu l'**artiste gagnant** pendant le show.

```
P_{Inv_Gagnants} = 0,40 √ó P_live

part_i = P_{Inv_Gagnants} √ó (votes_i / Œ£ votes_gagnant)
```

**M√©thode** : **Pro-rata votes** (ou montants investis selon param√©trage).

---

#### D) 10 % ‚Üí VISUAL

```
P_{VISUAL} = 0,10 √ó P_live
```

---

### R√®gles VSLS

#### Tranches ‚Ç¨ ‚Üí Votes

**Bar√®me commun** appliqu√© : 2 ‚Ç¨ = 1 vote, ..., 20 ‚Ç¨ = 10 votes.

---

#### Gestion des √âgalit√©s

En cas d'√©galit√© de votes :

1. **D√©partage 1** : Somme des **engagements** (likes, partages, commentaires)
2. **D√©partage 2** : **Anciennet√© du vote** (horodatage, premier vote = prioritaire)

---

#### Anti-Abus

**Protections actives** :

- **Limites de fr√©quence** : Max 10 votes/minute/user
- **D√©tection de patterns** : Bots, multi-comptes (fraud engine)
- **Annulation** : Si fraude d√©tect√©e ‚Üí votes invalid√©s + sanctions
- **Rate limiting** : Protection DDoS (100 req/15min par IP)

---

#### Tra√ßabilit√©

**Logs en temps r√©el** :

- **WebSocket** : Tous les votes horodat√©s (ms precision)
- **Journal d'√©v√©nements** : Actions, d√©tections, sanctions
- **Export CSV** : Audit complet post-show (disponible admin)

---

### D√©lai de Paiement

**Artistes** : T+2 jours ouvr√©s  
**Investisseurs gagnants** : T+3 jours ouvr√©s (apr√®s v√©rifications anti-fraude)

---

## 6) Rubrique **Petites Annonces** ‚Äî Mod√®le √âconomique Pro

### Principe

**Marketplace audiovisuelle** : Casting, mat√©riel, services, locaux.

**‚ö†Ô∏è IMPORTANT** : **Hors syst√®me d'investissement** (pas de votes, pas de pots).

---

### Mon√©tisation (4 leviers cumulables)

#### 1) Frais Fixes par Annonce

**Paliers** (configurables) :

| Formule | Prix | Dur√©e | Visibilit√© |
|---------|------|-------|------------|
| **Basic** | 5 ‚Ç¨ | 30 jours | Standard |
| **Pro** | 15 ‚Ç¨ | 60 jours | Mise en avant mod√©r√©e |
| **Premium** | 29 ‚Ç¨ | 90 jours | Top annonces + badge |

---

#### 2) Mise en Avant (Boosts)

**Tarifs** :

| Dur√©e | Prix |
|-------|------|
| 7 jours | 9 ‚Ç¨ |
| 14 jours | 15 ‚Ç¨ |
| 30 jours | 25 ‚Ç¨ |

**Effet** : Annonce √©pingl√©e en t√™te de cat√©gorie + badge "Sponsoris√©".

---

#### 3) Commission sur Transaction

**Si transaction conclue via la plateforme** :

```
Commission = Œ± % √ó Montant_net

Œ± = 8 % (param√©trable 5-15 %)
```

**Montant_net** = Prix convenu - Frais de paiement

**Tracking** : Via syst√®me d'escrow optionnel ou d√©claration manuelle.

---

#### 4) Abonnements Pro (Mensuels)

**Formules** :

| Plan | Prix/mois | Inclus |
|------|-----------|--------|
| **Starter** | 19 ‚Ç¨ | 5 annonces/mois + stats basiques |
| **Business** | 49 ‚Ç¨ | 20 annonces/mois + templates + priorit√© support |
| **Enterprise** | 99 ‚Ç¨ | Illimit√© + multi-utilisateurs + API access |

**Avantages** :
- Pas de frais par annonce (dans limite du plan)
- Outils avanc√©s (statistiques, A/B testing, CRM int√©gr√©)
- Support prioritaire

---

### Conformit√© & Op√©rations

#### RGPD

- **Consentement explicite** : Collecte donn√©es minimales
- **Conservation limit√©e** : 90 jours apr√®s expiration annonce
- **Droit √† l'oubli** : Suppression sur demande (< 30 jours)

---

#### Mod√©ration

**Syst√®me IA + Humain** :

- **Pr√©-mod√©ration IA** : D√©tection contenu interdit (70% automatique)
- **Revue manuelle** : Annonces signal√©es (< 24h)
- **Sanctions gradu√©es** :
  - 1er signalement valid√© : **Avertissement**
  - 2e signalement : **Suspension 7 jours**
  - 3e signalement : **Ban d√©finitif**

---

#### S√©curit√© Transactions

**Escrow optionnel** :

- Fonds bloqu√©s jusqu'√† validation service rendu
- Frais escrow : +2 % (en sus de la commission)
- D√©lai de d√©blocage : 48h apr√®s confirmation

**KYC Pro** :

- **Seuil** : > 5000 ‚Ç¨ de transactions/mois
- **Documents** : SIRET, RIB, pi√®ce d'identit√©
- **V√©rification** : < 72h (manuelle)

---

#### Facturation

- **Factures PDF** : G√©n√©ration automatique (conformes TVA/TVS)
- **Exports** : CSV/Excel pour comptabilit√©
- **Historique** : Conserv√© 10 ans (obligation l√©gale)

---

#### KPI M√©tiers

**Suivi admin** :

- **Taux de conversion** : Annonces ‚Üí Transactions
- **D√©lai de placement** : Temps moyen avant r√©ponse
- **ARPU** (Average Revenue Per User) : Revenus / Utilisateurs actifs
- **LTV** (Lifetime Value) : Valeur client sur 12 mois

---

## 7) R√®gles Transverses

### Arrondis

**M√©thode** : **2 d√©cimales** (0,01 ‚Ç¨)

**Gestion des r√©sidus** :

```
Œ£ parts_calcul√©es ‚â† pot_net  ‚Üí  r√©sidu ‚Üí VISUAL
```

**Objectif** : Bouclage exact au centime (√©viter √©carts comptables).

---

### Bar√®me Commun (Rappel)

**Application universelle** :

| ‚Ç¨ | 2 | 3 | 4 | 5 | 6 | 8 | 10 | 12 | 15 | 20 |
|---|---|---|---|---|---|---|----|----|----|----| 
| **Votes** | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |

**Impl√©mentation** : Client (`investmentCalculator.ts`) + Serveur (`voteService.ts`).

---

### RGPD & Anti-Fraude

#### Consentements

- **Cookies** : Banni√®re obligatoire (opt-in analytics)
- **Donn√©es sensibles** : Consentement explicite (KYC, paiements)
- **Marketing** : Opt-in s√©par√© (newsletters)

---

#### Anti-Fraude

**Protections** :

- **Caps par utilisateur** :
  - Podcasts : ‚â§ 20 % votes globaux/mois
  - VSLS : ‚â§ 10 votes/minute
- **Limites de fr√©quence** :
  - Investissements : ‚â§ 50 transactions/jour
  - Parrainage : ‚â§ 20 filleuls/mois
- **Scoring comportemental** :
  - D√©tection bots (fraud engine)
  - Multi-comptes (IP tracking, fingerprinting)
  - Patterns suspects (montants, timing)

---

#### Sanctions Gradu√©es

| Niveau | Action | Dur√©e |
|--------|--------|-------|
| **1** | Avertissement | - |
| **2** | Limitation actions | 7 jours |
| **3** | Suspension compte | 30 jours |
| **4** | Ban d√©finitif | Permanent |

---

### KYC & √Çge

#### Mineurs (16-17 ans)

- **Plafond investissement** : 200 ‚Ç¨ cumul√©s
- **Retraits** : Diff√©r√©s jusqu'√† 18 ans (sauf autorisation parentale)
- **KYC renforc√©** : Obligatoire √† la majorit√© (transition automatique)
- **Table d√©di√©e** : `minor_visitors` (schema.ts)

---

#### Majeurs

- **KYC standard** : Pi√®ce d'identit√© + justificatif domicile
- **Seuils** :
  - D√©p√¥t > 1000 ‚Ç¨ ‚Üí KYC obligatoire
  - Retrait > 500 ‚Ç¨ ‚Üí KYC + v√©rification bancaire

---

## 8) API & Settlement (R√©f√©rence Technique)

### Endpoints Principaux

#### A) Investissement

```http
POST /api/invest
Content-Type: application/json

{
  "category": "films" | "livres" | "podcasts" | "vsls",
  "targetId": "project_abc123",
  "amount": 10.00,
  "currency": "EUR"
}

‚Üí Cr√©dite votes selon bar√®me
‚Üí Retourne : { votes: 7, visupoints: 1000 }
```

---

#### B) Vente Unitaire

```http
POST /api/sale
Content-Type: application/json

{
  "category": "voix_info" | "livres" | "podcasts",
  "targetId": "article_xyz789",
  "price": 5.00,
  "currency": "EUR",
  "buyerId": "user_456"
}

‚Üí Split 70/30 imm√©diat
‚Üí Retourne : { 
    author_share: 3.50, 
    platform_share: 1.50,
    transaction_id: "txn_..."
  }
```

---

#### C) Cl√¥ture de Cycle

```http
POST /api/{category}/close
Authorization: Bearer {ADMIN_TOKEN}

{
  "period": "2025-10-24" | "2025-10",
  "force": false
}

‚Üí Fige pot
‚Üí Calcule payouts selon formules
‚Üí D√©clenche webhooks Stripe Connect
‚Üí Retourne : { 
    pot_net: 15420.50,
    payouts: [...],
    status: "completed"
  }
```

---

#### D) Rankings

```http
GET /api/{category}/rankings?period=2025-10&limit=100

‚Üí Retourne classements + parts calcul√©es
‚Üí Format : {
    rankings: [
      { rank: 1, target_id: "...", score: 1250, share: 520.30 },
      ...
    ],
    metadata: { period, total_pot, closed_at }
  }
```

---

### Pseudo-Code Settlement

```javascript
// 1) Calculer pot net
pot_net = pot_gross - stripe_fees - platform_fees

// 2) D√©finir cl√©s de r√©partition (selon cat√©gorie)
keys = {
  investors_top10: 0.40,
  creators_top10: 0.30,
  investors_11_100: 0.07,
  platform: 0.23
}

// 3) Calculer parts par cl√©
parts = keys.map(k => k.pct * pot_net)

// 4) Calculer poids individuels
weights = targets.map(t => {
  switch(category) {
    case 'films':
      return t.votes
    case 'podcasts':
      return t.votes * t.listen_score
    case 'vsls':
      return t.votes_for_winner
    // ...
  }
})

// 5) Distribuer chaque part
payouts = parts.map((part, key) => {
  eligible = targets.filter(t => t.eligible_for[key])
  
  return eligible.map(t => ({
    target_id: t.id,
    amount: part * (weights[t.id] / sum(weights[eligible])),
    key: key
  }))
})

// 6) Arrondir + g√©rer r√©sidus
payouts.forEach(p => p.amount = round(p.amount, 2))
residue = pot_net - sum(payouts.amount)
platform_share += residue

// 7) Enregistrer + d√©clencher paiements
await db.insert('payouts', payouts)
await stripe.transferBatch(payouts)
```

---

### Idempotence Webhooks

**Protection rejeu** :

```javascript
// Stripe webhook handler
app.post('/webhooks/stripe', async (req, res) => {
  const sig = req.headers['stripe-signature']
  const event = stripe.webhooks.constructEvent(req.body, sig, WEBHOOK_SECRET)
  
  // V√©rifier idempotence
  const existing = await db.query(
    'SELECT * FROM webhook_events WHERE event_id = ?',
    [event.id]
  )
  
  if (existing) {
    return res.status(200).send('Already processed')
  }
  
  // Traiter √©v√©nement
  await processStripeEvent(event)
  
  // Marquer comme trait√©
  await db.insert('webhook_events', {
    event_id: event.id,
    processed_at: new Date()
  })
  
  res.status(200).send('OK')
})
```

---

## 9) Check-list D√©ploiement

### Avant Mise en Production

#### Configuration

- [ ] **Bar√®me euros‚Üívotes** impl√©ment√© client + serveur
- [ ] **Cl√©s de r√©partition** test√©es :
  - [ ] 40/30/23/7 (Films/Vid√©os/Docs)
  - [ ] 70/30 (Ventes)
  - [ ] 60/40 (Voix de l'Info quotidien, Livres mensuel)
  - [ ] 40/30/20/10 (Podcasts mensuel)
  - [ ] 40/10/40/10 (VSLS)
- [ ] **Arrondis au centime** + v√©rification somme des parts = pot

---

#### Jobs Automatis√©s

- [ ] **CRON cl√¥tures** configur√©s :
  - [ ] Voix de l'Info : Quotidien 00:15 UTC+1
  - [ ] Livres : Mensuel (dernier jour 23:59)
  - [ ] Podcasts : Mensuel (dernier jour 23:59)
  - [ ] Films/Vid√©os/Docs : Param√©trable (admin)
- [ ] **Webhooks Stripe Connect** idempotents (rejeu safe)
- [ ] **Backup automatique** avant chaque cl√¥ture

---

#### Tests

- [ ] **Tests unitaires** : Coverage ‚â• 80 %
  - [ ] `revenueEngine.test.ts` (100 %)
  - [ ] `voteService.test.ts`
  - [ ] `settlementService.test.ts`
- [ ] **Tests E2E** : Sc√©narios complets
  - [ ] Cycle Films complet (invest ‚Üí classement ‚Üí cl√¥ture)
  - [ ] Vente Voix de l'Info + pot quotidien
  - [ ] VSLS battle avec √©galit√©

---

#### Exports & Conformit√©

- [ ] **Exports CSV/Excel** op√©rationnels :
  - [ ] Auteurs/cr√©ateurs (revenus, classements)
  - [ ] Investisseurs (gains, transactions)
  - [ ] Audits (logs, sanctions)
- [ ] **RGPD** : Conformit√© valid√©e
  - [ ] Consentement cookies impl√©ment√©
  - [ ] Export donn√©es personnelles (< 30 jours)
  - [ ] Droit √† l'oubli op√©rationnel
- [ ] **Anti-fraude** actif :
  - [ ] Rate limiting (4 niveaux)
  - [ ] Fraud detection engine
  - [ ] Caps par utilisateur
  - [ ] Limites de fr√©quence

---

#### Monitoring & Logs

- [ ] **Health checks** : `/healthz`, `/readyz`, `/metrics`
- [ ] **Logs structur√©s** : Actions sensibles audit√©es
- [ ] **Alertes** configur√©es :
  - [ ] √âchec cl√¥ture (email admin)
  - [ ] Fraude d√©tect√©e (SMS + email)
  - [ ] Erreur Stripe webhook (PagerDuty)
- [ ] **Dashboard admin** : M√©triques temps r√©el
  - [ ] Pots en cours
  - [ ] Classements live
  - [ ] Transactions du jour

---

#### S√©curit√©

- [ ] **Headers s√©curis√©** : CSP, HSTS, X-Frame-Options
- [ ] **CORS** strict en production
- [ ] **Secrets** : Rotation cl√©s API (Stripe, Bunny.net)
- [ ] **Audit trail HMAC** : Signatures cryptographiques
- [ ] **Row Level Security** : Policies PostgreSQL actives

---

#### Documentation

- [ ] **README technique** √† jour
- [ ] **API documentation** (Swagger/OpenAPI)
- [ ] **Guides utilisateurs** :
  - [ ] Investisseurs (comment voter, comprendre les pots)
  - [ ] Cr√©ateurs (d√©p√¥t contenu, quotas, revenus)
  - [ ] Admin (cl√¥tures manuelles, mod√©ration)
- [ ] **Runbooks** :
  - [ ] Proc√©dure rollback
  - [ ] Incident response
  - [ ] R√©conciliation Stripe

---

### Apr√®s D√©ploiement

#### Smoke Tests (J0)

- [ ] Cr√©er investissement test (2 ‚Ç¨) ‚Üí v√©rifier 1 vote
- [ ] Acheter article Voix de l'Info ‚Üí v√©rifier split 70/30
- [ ] D√©clencher cl√¥ture manuelle ‚Üí v√©rifier calculs
- [ ] Consulter rankings ‚Üí v√©rifier affichage

---

#### Monitoring (J+7)

- [ ] V√©rifier CRON ex√©cut√©s (logs)
- [ ] Comparer pots calcul√©s vs Stripe (r√©conciliation)
- [ ] Analyser erreurs 5xx (< 0.1 % attendu)
- [ ] Valider temps r√©ponse API (< 200ms P95)

---

#### Optimisation (J+30)

- [ ] Analyser requ√™tes lentes (PostgreSQL `pg_stat_statements`)
- [ ] Ajuster caps anti-fraude (si n√©cessaire)
- [ ] Optimiser index DB (classements, rankings)
- [ ] R√©viser formules si edge cases d√©tect√©s

---

## üìä TABLEAUX R√âCAPITULATIFS

### R√©partitions par Cat√©gorie

| Cat√©gorie | Cr√©ateurs | Investisseurs | Plateforme | Autre |
|-----------|-----------|---------------|------------|-------|
| **Films/Vid√©os/Docs** | 30 % (TOP 10) | 40 % (TOP 10) + 7 % (11-100) | 23 % | - |
| **Voix de l'Info** (vente) | 70 % | - | 30 % | - |
| **Voix de l'Info** (pot) | 60 % (TOP 10) | - | - | 40 % lecteurs |
| **Livres** (vente) | 70 % | - | 30 % | - |
| **Livres** (pot) | 60 % (TOP 10) | - | - | 40 % lecteurs-inv. |
| **Podcasts** (vente) | 70 % | - | 30 % | - |
| **Podcasts** (pot) | 40 % | 30 % | 20 % | 10 % bonus |
| **VSLS** | 40 % gagnant + 10 % perdant | 40 % (gagnants) | 10 % | - |
| **Petites Annonces** | - | - | 100 % (hors invest.) | - |

---

### Fr√©quences de Cl√¥ture

| Cat√©gorie | Fr√©quence | Heure (UTC+1) | Automatique |
|-----------|-----------|---------------|-------------|
| **Films/Vid√©os/Docs** | Param√©trable | Variable | ‚ùå (Admin) |
| **Voix de l'Info** | Quotidienne | 00:15 | ‚úÖ (CRON) |
| **Livres** | Mensuelle | Dernier jour 23:59 | ‚úÖ (CRON) |
| **Podcasts** | Mensuelle | Dernier jour 23:59 | ‚úÖ (CRON) |
| **VSLS** | Imm√©diate | Fin du show | ‚úÖ (WebSocket) |
| **Petites Annonces** | - | - | ‚ùå (N/A) |

---

### Quotas Cr√©ateurs

| Type | Dur√©e Vid√©o | Prix | Quota | Cat√©gorie |
|------|-------------|------|-------|-----------|
| **Clip** | ‚â§ 5 min | 2 ‚Ç¨ | 2/mois | Films |
| **Documentaire** | 5-30 min | 5-10 ‚Ç¨ | 1/mois | Documentaires |
| **Film** | > 30 min | 15 ‚Ç¨ | 1/trimestre | Films |
| **Article** | - | Variable | Illimit√© | Voix de l'Info |
| **Livre** | - | Variable | 1/mois | Livres |
| **√âpisode Podcast** | - | Variable | Illimit√© | Podcasts |

---

### Limites Anti-Fraude

| Action | Limite | P√©riode | Sanction |
|--------|--------|---------|----------|
| **Votes VSLS** | 10 | 1 minute | Rate limit |
| **Investissements** | 50 | 1 jour | Avertissement |
| **Parrainage** | 20 filleuls | 1 mois | Suspension |
| **Podcasts (votes)** | 20 % du total | 1 mois | Cap appliqu√© |
| **Requ√™tes API** | 100 | 15 minutes | 429 Too Many Requests |

---

## üîê S√âCURIT√â & CONFORMIT√â

### Niveaux de KYC

| Niveau | D√©clencheur | Documents | D√©lai V√©rification |
|--------|-------------|-----------|-------------------|
| **KYC 0** | Inscription | Email | Instantan√© |
| **KYC 1** | Investissement > 100 ‚Ç¨ | Pi√®ce d'identit√© | < 24h |
| **KYC 2** | Retrait > 500 ‚Ç¨ | + Justificatif domicile | < 48h |
| **KYC 3** | Transactions > 5000 ‚Ç¨/mois | + SIRET (pro) | < 72h |

---

### RGPD - Conservation des Donn√©es

| Type de Donn√©e | Dur√©e | Base L√©gale |
|----------------|-------|-------------|
| **Compte utilisateur** | Jusqu'√† suppression demand√©e | Consentement |
| **Transactions financi√®res** | 10 ans | Obligation l√©gale |
| **Logs d'audit** | 1 an | Int√©r√™t l√©gitime |
| **Cookies analytics** | 13 mois | Consentement |
| **Petites annonces expir√©es** | 90 jours | Consentement |

---

### Sanctions Gradu√©es (Mod√©ration)

| Infraction | 1√®re fois | 2√®me fois | 3√®me fois | Gravit√© Imm√©diate |
|------------|-----------|-----------|-----------|-------------------|
| **Spam** | Avertissement | Suspension 7j | Suspension 30j | Ban si bot |
| **Contenu offensant** | Masquage + avertissement | Suspension 30j | Ban d√©finitif | Ban si p√©dopornographie |
| **Fraude votes** | Annulation + avertissement | Suspension 30j | Ban d√©finitif | Ban si coordonn√© |
| **Multi-comptes** | Fusion comptes | Suspension 30j | Ban tous comptes | Ban si ferme de clics |

---

## üöÄ FORMULES COMPL√àTES (Synth√®se Technique)

### Films / Vid√©os / Documentaires

```
P = pot_net apr√®s frais

Investisseurs TOP 10:
  P_I_top10 = 0.40 √ó P
  part_i = P_I_top10 √ó (V_i / Œ£ V_top10)

Porteurs TOP 10:
  P_C_top10 = 0.30 √ó P
  part_c = P_C_top10 √ó (score_c / Œ£ score_top10)

Investisseurs 11-100:
  P_I_11_100 = 0.07 √ó P
  part_i = P_I_11_100 / count(11-100)  [√©quiparti]

VISUAL:
  P_VISUAL = 0.23 √ó P
```

---

### Voix de l'Info

**Vente:**
```
Net_vente = Prix - Frais
Auteur = 0.70 √ó Net_vente
VISUAL = 0.30 √ó Net_vente
```

**Pot quotidien:**
```
P_day = pot_net du jour

Auteurs TOP 10:
  P_auteurs = 0.60 √ó P_day
  part_a = P_auteurs √ó (score_a / Œ£ score_top10)

Lecteurs gagnants:
  P_lecteurs = 0.40 √ó P_day
  W_i = Œ£ (votes_i √ó poids_c)
  part_i = P_lecteurs √ó (W_i / Œ£ W)
```

---

### Livres

**Vente:**
```
Net_vente = Prix - Frais
Auteur = 0.70 √ó Net_vente
VISUAL = 0.30 √ó Net_vente
```

**Pot mensuel:**
```
P_mois = pot_net mensuel

Auteurs TOP 10:
  P_auteurs = 0.60 √ó P_mois
  part_a = P_auteurs √ó (score_a / Œ£ score_top10)

Lecteurs-investisseurs gagnants:
  P_lecteurs_inv = 0.40 √ó P_mois
  W_i = Œ£ (votes_i √ó poids_c)
  part_i = P_lecteurs_inv √ó (W_i / Œ£ W)
```

---

### Podcasts

**Vente:**
```
Net_vente = Prix - Frais
Porteur = 0.70 √ó Net_vente
VISUAL = 0.30 √ó Net_vente
```

**Pot mensuel:**
```
P = pot_net mensuel

Porteurs:
  P_porteurs = 0.40 √ó P
  score_audio = impressions √ó compl√©tion
  part_p = P_porteurs √ó (score_audio_p / Œ£ score_audio)

Investisseurs:
  P_inv = 0.30 √ó P
  listen_score = 0.7 √ó compl√©tion + 0.3 √ó auditeurs_uniques_norm
  weight_i = votes_i √ó listen_score_i
  
  IF votes_i / Œ£ votes_total > 0.20 THEN
    weight_i_capped = 0.20 √ó Œ£ votes_total √ó listen_score_i
  
  part_i = P_inv √ó (weight_i / Œ£ weights)

VISUAL:
  P_VISUAL = 0.20 √ó P

Bonus Pool:
  P_bonus = 0.10 √ó P
```

---

### VSLS (Visual Studio Live Show)

```
P_live = pot_net du show

Artiste gagnant:
  P_gagnant = 0.40 √ó P_live

Artiste perdant:
  P_perdant = 0.10 √ó P_live

Investisseurs gagnants:
  P_inv_gagnants = 0.40 √ó P_live
  part_i = P_inv_gagnants √ó (votes_i / Œ£ votes_gagnant)

VISUAL:
  P_VISUAL = 0.10 √ó P_live

√âgalit√©s:
  1. D√©partage par engagement = likes + shares + comments
  2. Si √©galit√© ‚Üí anciennet√© du vote (timestamp ASC)
```

---

## üìà M√âTRIQUES DE SUCC√àS (KPI)

### Engagement Utilisateurs

- **DAU/MAU** (Daily/Monthly Active Users) : Objectif > 30 %
- **Taux de r√©tention J7** : > 40 %
- **Temps moyen session** : > 8 minutes
- **Investissements moyens par user/mois** : > 15 ‚Ç¨

---

### Performance √âconomique

- **GMV** (Gross Merchandise Value) : Somme pots mensuels
- **Take rate** : Revenus plateforme / GMV (objectif 20-25 %)
- **ARPU** (Average Revenue Per User) : Revenus / MAU
- **LTV/CAC** : Lifetime Value / Co√ªt d'Acquisition (objectif > 3)

---

### Qualit√© Contenu

- **Taux d'approbation projets** : < 60 % (s√©lectivit√©)
- **Score moyen qualit√©** (IA) : > 7/10
- **Taux de compl√©tion vid√©os** : > 65 %
- **NPS** (Net Promoter Score) cr√©ateurs : > 50

---

### Op√©rationnel

- **Uptime** : > 99.9 %
- **Temps r√©ponse API P95** : < 200ms
- **Erreurs 5xx** : < 0.1 %
- **Temps cl√¥ture cycle** : < 5 minutes

---

## üîÑ CYCLES DE VIE

### Cycle Mensuel Livres

```
Jour 1 00:00:00 Europe/Paris
  ‚Üì
Ouverture cycle N
  ‚Üì
Auteurs actifs (max 100)
  ‚Üì
Investissements + Ventes (70/30 imm√©diat)
  ‚Üì
Jour 30/31 23:59:59
  ‚Üì
Cl√¥ture automatique (CRON)
  ‚Üì
Calcul classements (score final)
  ‚Üì
Distribution pot 60/40
  ‚Üì
J+1 00:00:00
  ‚Üì
Fen√™tre rep√™chage 24h (rangs 11-100)
  ‚Üì
J+2 00:00:00
  ‚Üì
Auto-report TOP 10 vers cycle N+1
  ‚Üì
Nouveaux auteurs file d'attente ‚Üí cycle N+1
```

---

### Cycle Quotidien Voix de l'Info

```
Jour J 00:00:00
  ‚Üì
Ventes articles (70/30 imm√©diat)
  ‚Üì
Accumulation pot quotidien
  ‚Üì
Jour J 23:59:59
  ‚Üì
Fige pot_day
  ‚Üì
Jour J+1 00:15:00 (CRON)
  ‚Üì
Calcul TOP 10 auteurs (score)
  ‚Üì
Distribution 60% auteurs + 40% lecteurs
  ‚Üì
Paiements J+2 (apr√®s v√©rifications)
  ‚Üì
Archive classement + nouveau cycle J+1
```

---

## üõ†Ô∏è OUTILS ADMIN

### Dashboard Principal

**URL** : `/admin/dashboard`

**Sections** :
1. **Vue d'ensemble** : M√©triques temps r√©el
2. **Utilisateurs** : KYC, sanctions, mineurs
3. **Financier** : Pots en cours, r√©conciliation Stripe
4. **Projets** : Mod√©ration, approbations
5. **Live Shows** : Gestion battles VSLS
6. **Livres** : Queue management (10K auteurs visible)
7. **Toggles** : ON/OFF cat√©gories (7) + rubrique (1)
8. **Logo** : Visibilit√© logo officiel
9. **Logs** : Audit trail, fraude d√©tect√©e

---

### Actions Rapides

**Cl√¥ture manuelle cycle** :
```bash
# Via API
curl -X POST https://visual.com/api/admin/films/close \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{"period":"2025-10-24","force":false}'

# Via CLI (si disponible)
yarn admin:close --category=films --period=2025-10-24
```

**Export donn√©es** :
```bash
# Transactions mois
yarn admin:export --type=transactions --period=2025-10 --format=csv

# Classements cat√©gorie
yarn admin:export --type=rankings --category=livres --period=2025-10
```

**Rollback d√©ploiement** :
```bash
# Rollback automatique
make rollback

# Rollback vers version sp√©cifique
./scripts/quick-rollback.sh v2.5.8
```

---

## ‚ùì FAQ TECHNIQUES

### Q1 : Que se passe-t-il si un pot net est n√©gatif ?

**R** : Impossible par design. Le pot net = somme investissements ‚àí frais Stripe. Minimum th√©orique = 0 ‚Ç¨.  
Si aucun investissement ‚Üí cycle non cl√¥tur√© (seuil minimum configurable, ex. 100 ‚Ç¨).

---

### Q2 : Comment g√©rer les ex-aequo au vote ?

**R** : 
1. **D√©partage 1** : Somme engagements (likes + shares + comments)
2. **D√©partage 2** : Anciennet√© du premier vote (timestamp ASC)
3. **Si toujours √©galit√©** : Les deux cibles partagent √©quitablement la part

---

### Q3 : Le cap 20 % Podcasts s'applique-t-il avant ou apr√®s calcul ?

**R** : **Avant distribution**. Le `weight_i` est plafonn√©, puis les parts sont recalcul√©es pro-rata des weights plafonn√©s.

**Exemple** :
```
User A : 10000 votes (50 % du total) ‚Üí capped √† 4000 votes (20 %)
User B : 8000 votes (40 %) ‚Üí conserve 8000 votes
User C : 2000 votes (10 %) ‚Üí conserve 2000 votes

Nouvelle base : 14000 votes (4000 + 8000 + 2000)
Parts recalcul√©es sur cette base.
```

---

### Q4 : Les frais Stripe sont-ils d√©duits avant ou apr√®s r√©partition ?

**R** : **Avant**. 

```
pot_gross = Œ£ investissements
stripe_fees = pot_gross √ó 0.029 + 0.25 ‚Ç¨ (estimation)
pot_net = pot_gross - stripe_fees

R√©partitions appliqu√©es sur pot_net uniquement.
```

---

### Q5 : Peut-on modifier les formules en production ?

**R** : ‚ö†Ô∏è **Non recommand√©** sauf :
- Migration majeure (avec p√©riode de transition)
- Correction bug critique (avec rollback plan)

**Process s√©curis√©** :
1. Feature flag pour nouvelle formule
2. Phase A/B testing (ex. 10 % utilisateurs)
3. Comparaison r√©sultats ancien/nouveau
4. Migration progressive (30 jours)
5. Archive anciennes formules (audit)

---

### Q6 : Comment auditer les calculs de r√©partition ?

**R** : Table `payout_audit` :

```sql
CREATE TABLE payout_audit (
  id UUID PRIMARY KEY,
  cycle_id UUID NOT NULL,
  category VARCHAR(50) NOT NULL,
  formula_version VARCHAR(20) NOT NULL,
  pot_gross DECIMAL(10,2) NOT NULL,
  pot_net DECIMAL(10,2) NOT NULL,
  stripe_fees DECIMAL(10,2) NOT NULL,
  payouts JSONB NOT NULL, -- D√©tail par target
  residue DECIMAL(10,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- V√©rification somme
SELECT 
  cycle_id,
  pot_net,
  SUM((payout->>'amount')::DECIMAL) as total_paid,
  pot_net - SUM((payout->>'amount')::DECIMAL) as delta
FROM payout_audit, jsonb_array_elements(payouts) as payout
GROUP BY cycle_id, pot_net
HAVING ABS(pot_net - SUM((payout->>'amount')::DECIMAL)) > 0.01;
```

---

## üéì GLOSSAIRE

**CAP** : Plafond appliqu√© pour limiter la part d'un acteur (anti-monopole).

**Compl√©tion** : Pourcentage moyen de lecture/√©coute d'un contenu (0 √† 1).

**√âquiparti** : Distribution en parts √©gales (montant / nombre de b√©n√©ficiaires).

**Escrow** : S√©questre de fonds jusqu'√† validation d'une transaction.

**GMV** : Gross Merchandise Value, volume total √©chang√© sur la plateforme.

**Idempotence** : Propri√©t√© garantissant qu'une op√©ration ex√©cut√©e N fois produit le m√™me r√©sultat qu'une seule fois (crucial pour webhooks).

**KYC** : Know Your Customer, v√©rification d'identit√© r√©glementaire.

**Listen Score** : M√©trique Podcasts combinant compl√©tion et auditeurs uniques.

**Pot net** : Montant disponible pour distribution apr√®s d√©duction de tous les frais.

**Pro-rata** : Distribution proportionnelle √† un poids (votes, score, montant).

**Rep√™chage** : M√©canisme permettant aux rangs 11-100 de repasser au cycle suivant via ticket payant.

**R√©sidu** : Diff√©rence due aux arrondis entre pot net et somme des parts distribu√©es (affect√© √† VISUAL).

**RLS** : Row Level Security, s√©curit√© au niveau des lignes PostgreSQL.

**Settlement** : Processus de r√®glement financier (calcul + paiements).

**Take rate** : Pourcentage pr√©lev√© par la plateforme sur les transactions.

**VISUpoints** : Monnaie virtuelle interne (100 VP = 1 ‚Ç¨), utilis√©e pour r√©compenses et pouvoir de vote.

**Webhook** : Notification HTTP automatique d'un √©v√©nement (ex. paiement Stripe confirm√©).

---

## üìû CONTACTS & SUPPORT

**√âquipe Technique** : dev@visual-platform.com  
**Support Admin** : admin@visual-platform.com  
**RGPD / DPO** : rgpd@visual-platform.com  
**Urgences Production** : +33 X XX XX XX XX (PagerDuty)

**Documentation Compl√®te** : https://docs.visual-platform.com  
**Status Page** : https://status.visual-platform.com  
**GitHub** : https://github.com/visual-org/platform

---

## üìÑ CHANGELOG

**v2025-10-24** :
- ‚úÖ Ajout formule Podcasts 40/30/20/10 avec `listen_score`
- ‚úÖ Clarification VSLS 40/10/40/10 + r√®gles anti-abus
- ‚úÖ D√©tail mod√®le √©conomique Petites Annonces (4 revenus)
- ‚úÖ Sp√©cification cap 20 % Podcasts (anti-capture)
- ‚úÖ Ajout cycle quotidien Voix de l'Info (J ‚Üí J+1 00:15)
- ‚úÖ Pr√©cision syst√®me rep√™chage Livres (25 ‚Ç¨, 24h)
- ‚úÖ Pseudo-code settlement complet
- ‚úÖ Check-list d√©ploiement exhaustive
- ‚úÖ Tableaux r√©capitulatifs + glossaire

**v2.6** (Janvier 2025) :
- Syst√®me Livres complet (queue 10K auteurs)
- Toggles cat√©gories/rubriques (7+1)
- Middleware auth centralis√©

**v2.5** :
- Formule 40/30/23/7 Films/Vid√©os/Docs stabilis√©e
- Bar√®me commun 2-20 ‚Ç¨ ‚Üí 1-10 votes

---

## ‚úÖ VALIDATION FINALE

**Document valid√© par** :
- [ ] Lead Developer
- [ ] Product Manager
- [ ] CFO (Formules financi√®res)
- [ ] Legal (RGPD, conformit√©)
- [ ] QA Lead (Tests coverage)

**Date validation** : _____________________

**Signature** : _____________________

---

**FIN DU DOCUMENT**

*Ce document constitue la r√©f√©rence officielle pour l'impl√©mentation des formules math√©matiques et r√©partitions de la plateforme VISUAL.*

*Toute modification doit faire l'objet d'une validation et d'une nouvelle version.*

**Version** : 2025-10-24  
**Statut** : ‚úÖ VALID√â POUR D√âPLOIEMENT  
**Prochain audit** : 2025-11-24